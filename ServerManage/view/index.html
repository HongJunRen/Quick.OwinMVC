<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>服务器监控系统</title>
    #*
    <script type="text/javascript" src="../resource/scripts/jquery.min.js"></script>
    *#
    #parse("ServerManage:part_head_content")
    <script type="text/javascript" src="../resource/amcharts/amcharts.js"></script>
    <script type="text/javascript" src="../resource/amcharts/pie.js"></script>
    <script type="text/javascript" src="../resource/amcharts/serial.js"></script>
    <script type="text/javascript" src="../resource/scripts/charts.function.js"></script>
    <script type="text/javascript" language="javascript">
        // 对Date的扩展，将 Date 转化为指定格式的String
        // 月(M)、日(d)、小时(h)、分(m)、秒(s)、季度(q) 可以用 1-2 个占位符， 
        // 年(y)可以用 1-4 个占位符，毫秒(S)只能用 1 个占位符(是 1-3 位的数字) 
        // 例子： 
        // (new Date()).Format("yyyy-MM-dd hh:mm:ss.S") ==> 2006-07-02 08:09:04.423 
        // (new Date()).Format("yyyy-M-d h:m:s.S")      ==> 2006-7-2 8:9:4.18 
        Date.prototype.format = function (fmt) { //author: meizz 
            var o = {
                "M+": this.getMonth() + 1, //月份 
                "d+": this.getDate(), //日 
                "H+": this.getHours(), //小时 
                "m+": this.getMinutes(), //分 
                "s+": this.getSeconds(), //秒 
                "q+": Math.floor((this.getMonth() + 3) / 3), //季度 
                "S": this.getMilliseconds() //毫秒 
            };
            if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
            for (var k in o)
                if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
            return fmt;
        }

        AmCharts.ready(function () {

            var ramPieCharts_Data = [{}];
            var ramPieCharts_LastUsedRamM = 0;
            var ramPieCharts = createPieCharts({
                divName: "divMemoryChart",
                dataProvider: ramPieCharts_Data,
                balloonText: "[[title]]:[[value]]M ([[percents]]%)",
                radius: 100
            });

            var cpuSerialCharts_MaxDataCount = 100;
            var cpuSerialCharts_Data = [];
            var currentTime = new Date();
            currentTime.setSeconds(currentTime.getSeconds() - cpuSerialCharts_MaxDataCount);

            for (i = 0; i < cpuSerialCharts_MaxDataCount; i++) {
                currentTime.setSeconds(currentTime.getSeconds() + 1);
                cpuSerialCharts_Data.push({ time: currentTime.format("yyyy-MM-dd HH:mm:ss") });
            }

            var cpuSerialCharts = createSerialCharts({
                divName: "divCpuChart",
                dataProvider: cpuSerialCharts_Data,
                titleList: ["使用率"],
                valueFieldList: ["value"],
                valAxisMinimum: "0",
                valueUnit: "%",
                dateFormat: "JJ:NN:SS",
                minPeriod: "ss",
                dataDateFormat: "YYYY-MM-DD JJ:NN:SS"
            });
            
            var isContinue = true;
            var refrashDataFunc = function () {
                //刷新数据
                jQuery.ajax({
                    dataType: "json",
                    url: "../api/index?type=info",
                    success: function (json) {
                        var basic = json.basic;
                        var cpu = json.cpu;
                        var memory = json.memory;

                        //基本信息
                        jQuery("#tdOSName").html(basic.os_name);
                        jQuery("#tdComputerName").html(basic.computer_name);
                        jQuery("#tdProcessRunTime").html(basic.process_run_time);

                        //内存信息
                        var usedRamM = Math.round(memory.used / 1024 / 1024);
                        //仅当已使用内存的数据变化时，才更新饼图
                        if (usedRamM != ramPieCharts_LastUsedRamM) {
                            ramPieCharts_LastUsedRamM = usedRamM;
                            var freeRamM = Math.round(memory.free / 1024 / 1024);
                            ramPieCharts_Data.splice(0, ramPieCharts_Data.length
                            , { title: "剩余内存", value: freeRamM }
                            , { title: "已使用内存", value: usedRamM });
                            ramPieCharts.validateData();
                        }

                        //CPU信息
                        while (cpuSerialCharts_Data.length > cpuSerialCharts_MaxDataCount) {
                            cpuSerialCharts_Data.shift();
                        }
                        cpuSerialCharts_Data.push({ time: json.time, value: Math.round(cpu.used) });
                        cpuSerialCharts.validateData();
                    }
                }).error(function (obj, textStatus, ex) {
                    if (obj.status == 401)
                        isContinue = false;
                });
                //5秒后再次执行
                if (isContinue)
                    setTimeout(refrashDataFunc, $refreshInterval);
            }
            refrashDataFunc();
        });
    </script>
</head>
<body>
    <div id="body-wrapper">
        #parse("ServerManage:part_systembar")
        #parse("ServerManage:part_sidebar")
        <div id="main-content">
            <div class="content-box">
                <!-- Start Content Box -->
                <div class="content-box-header">
                    <h3>基本信息</h3>
                    <ul class="content-box-tabs"></ul>
                    <div class="clear"></div>
                </div>
                <!-- End .content-box-header -->
                <div class="content-box-content">
                    <div class="tab-content default-tab" id="tab1">
                        <div id="page-intro">
                            <div>
                                <table>
                                    <tbody>
                                        <tr>
                                            <td style="font-weight:700">计算机：</td>
                                            <td id="tdComputerName"></td>
                                            <td></td>
                                            <td></td>
                                        </tr>
                                        <tr>
                                            <td style="font-weight:700">操作系统：</td>
                                            <td id="tdOSName"></td>
                                            <td></td>
                                            <td></td>
                                        </tr>
                                        <tr>
                                            <td style="font-weight:700">进程运行时长：</td>
                                            <td id="tdProcessRunTime"></td>
                                            <td></td>
                                            <td></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="content-box">
                <!-- Start Content Box -->
                <div class="content-box-header">
                    <h3>性能信息</h3>
                    <ul class="content-box-tabs"></ul>
                    <div class="clear"></div>
                </div>
                <!-- End .content-box-header -->
                <div class="content-box-content">
                    <div class="tab-content default-tab" id="tab1">
                        <div id="page-intro">
                            <table>
                                <thead>
                                    <tr>
                                        <td style="font-weight:700">CPU</td>
                                        <td style="font-weight:700">内存</td>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="width: 100%;">
                                            <div id="divCpuChart" style="float:left; width: 100%;height: 300px; text-align:center;"></div>
                                        </td>
                                        <td>
                                            <div style="width: 300px;height: 300px;">
                                                <div id="divMemoryChart" style="float:left; width: 100%;height: 100%; text-align:center;"></div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="clear"></div>
            <!-- End .clear -->
            #parse("ServerManage:part_footer")
        </div>
    </div>
</body>
</html>